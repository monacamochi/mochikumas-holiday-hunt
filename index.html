<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ã‚‚ã¡ãã¾ã®ä»•äº‹ã‚ˆã‘ã‚²ãƒ¼ãƒ </title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: #fff; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; }
    
    #game-wrap { 
      width: 100vw; 
      height: 100vh; 
      height: 100dvh; 
      position: relative; 
      background: #eef6ff; 
      display: flex; 
      flex-direction: column; 
    }
    
    #status { 
      height: 60px; 
      display: flex; 
      justify-content: space-around; 
      align-items: center; 
      font-weight: bold; 
      color: #666; 
      background: #f5faff; 
      border-bottom: 1px solid #dee7ef; 
      z-index: 10; 
    }
    #life { color: #ff6b6b; }
    
    #mute-btn {
      position: absolute; top: 15px; right: 15px; width: 30px; height: 30px;
      background: none; border: none; font-size: 1.5rem; cursor: pointer; z-index: 30; outline: none;
    }

    #game-field { flex: 1; position: relative; overflow: hidden; width: 100%; }
    
    #mochikuma {
      width: 120px; height: 120px; position: absolute; bottom: 40px; left: 50%;
      transform: translate3d(-50%, 0, 0); background-size: contain; background-repeat: no-repeat;
      background-position: center; transition: transform 0.1s ease-out; z-index: 5; will-change: transform;
    }
    #mochikuma.dodging { transform: translate3d(50%, 0, 0); }
    
    #countdown { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: bold; color: #555; z-index: 15; }
    .obj { position: absolute; left: 50%; top: 0; padding: 10px 20px; border-radius: 8px; font-weight: bold; white-space: nowrap; z-index: 4; transform: translate3d(-50%, -100px, 0); will-change: transform; }
    .job { background: #555; color: #fff; }
    .rest { background: #ffeb3b; color: #333; }
    
    #ui-area { 
      height: 140px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: #f5faff; 
      border-top: 1px solid #dee7ef; 
      z-index: 10;
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    #dodge-btn { 
      width: 70%; height: 80px; font-size: 1.8rem; font-weight: bold; 
      background: #0056b3; border: none; border-radius: 40px; 
      color: #ffffff; outline: none; box-shadow: 0 4px 0 #003d7a;
    }
    #dodge-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #003d7a; }

    #msg-layer, #rule-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; display: flex; justify-content: center; align-items: flex-start; padding-top: 80px; z-index: 20; }
    
    /* 577x409ã®æ¯”ç‡ã«åˆã‚ã›ã¦èª¿æ•´ */
    #msg-content { 
      text-align: center; 
      padding: 40px 30px; 
      background-image: url('kumo.png');
      background-size: 100% 100%;
      background-repeat: no-repeat;
      background-position: center;
      background-color: transparent;
      border: none;
      width: 320px; /* iPhoneSEç­‰ã®å°å‹ç«¯æœ«ã‚‚è€ƒæ…®ã—ãŸå¹… */
      height: 227px; /* 320px ã«å¯¾ã™ã‚‹ 577:409 ã®æ¯”ç‡è¨ˆç®—å€¤ */
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      box-shadow: none;
    }

    #rule-content { text-align: center; padding: 25px; background: #fff; border: 1px solid #eee; border-radius: 12px; width: 85%; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    #msg-text { font-size: 1.1rem; font-weight: bold; margin-bottom: 12px; color: #444; line-height: 1.4; }
    #start-btn, #rule-btn, #close-rule-btn { padding: 10px 20px; margin: 5px; font-size: 0.9rem; font-weight: bold; border-radius: 10px; border: 1px solid #ccc; background: #fff; }
    #start-btn { background: #eee; }
    #rule-content p { font-size: 0.95rem; margin-bottom: 10px; text-align: left; line-height: 1.5; color: #444; }
    #loading-text { font-weight: bold; color: #aaa; padding: 30px; letter-spacing: 0.05em; }
    #preloader { position: absolute; width: 0; height: 0; overflow: hidden; opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
<div id="preloader"></div>
<audio id="bgm" src="bgm.mp3" loop></audio>

<div id="game-wrap">
  <button id="mute-btn">ğŸ”Š</button>
  <div id="status">
    <div id="score">SCORE: 0</div>
    <div id="life">LIFE: â¤â¤â¤</div>
  </div>
  <div id="game-field">
    <div id="mochikuma"></div>
    <div id="countdown" style="display: none;"></div>
  </div>
  <div id="msg-layer">
    <div id="msg-content">
      <div id="loading-text">Now loading...</div>
      <div id="menu-area" style="display: none;">
        <p id="msg-text">ã‚‚ã¡ãã¾ã®ä»•äº‹ã‚ˆã‘ã‚²ãƒ¼ãƒ </p>
        <div id="menu-btns">
          <button id="start-btn">é–‹å§‹</button>
          <button id="rule-btn">ãƒ«ãƒ¼ãƒ«</button>
        </div>
      </div>
    </div>
  </div>
  <div id="rule-layer" style="display: none;">
    <div id="rule-content">
      <h3>ã€ãƒ«ãƒ¼ãƒ«ã€‘</h3>
      <p>ãƒ»ä¸Šã‹ã‚‰è½ã¡ã¦ãã‚‹ã€Œä»•äº‹ã€ã‚’é¿ã‘ã‚‹</p>
      <p>ãƒ»ã€Œä¼‘ã¿ã€ã¯å½“ãŸã£ã¦å–å¾—ã™ã‚‹</p>
      <p>ãƒ»ã€Œã‚ˆã‘ã‚‹ã€ãƒœã‚¿ãƒ³é•·æŠ¼ã—ã§å³ç§»å‹•</p>
      <p>ãƒ»ã€Œä¼‘ã¿ã€ã‚’3å›é€ƒã™ã¨çµ‚äº†</p>
      <button id="close-rule-btn">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="ui-area">
    <button id="dodge-btn">ã‚ˆã‘ã‚‹</button>
  </div>
</div>

<script>
const mk = document.getElementById('mochikuma');
const dodgeBtn = document.getElementById('dodge-btn');
const msgLayer = document.getElementById('msg-layer');
const ruleLayer = document.getElementById('rule-layer');
const countdownDisp = document.getElementById('countdown');
const msgText = document.getElementById('msg-text');
const scoreDisp = document.getElementById('score');
const lifeDisp = document.getElementById('life');
const startBtn = document.getElementById('start-btn');
const ruleBtn = document.getElementById('rule-btn');
const closeRuleBtn = document.getElementById('close-rule-btn');
const loadingText = document.getElementById('loading-text');
const menuArea = document.getElementById('menu-area');
const preloader = document.getElementById('preloader');
const bgm = document.getElementById('bgm');
const muteBtn = document.getElementById('mute-btn');

const IMAGES = {
  NORMAL: 'default.png',
  DODGE:  'yoke.png',
  HIT_JOB: 'shigoto.png',
  HIT_REST: 'yasumi.png',
  KUMO: 'kumo.png'
};

let state = { score: 0, life: 3, active: false, dodging: false, speed: 6, canStart: true, isMuted: false };
let spawnTimer = null;

muteBtn.addEventListener('click', () => {
  state.isMuted = !state.isMuted;
  bgm.muted = state.isMuted;
  muteBtn.innerText = state.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
});

function preloadAllImages(imageObj, callback) {
  const urls = Object.values(imageObj);
  let loadedCount = 0;
  urls.forEach(url => {
    const img = new Image();
    img.onload = img.onerror = () => { 
      loadedCount++; 
      const cacheImg = img.cloneNode();
      preloader.appendChild(cacheImg);
      if (loadedCount === urls.length) callback(); 
    };
    img.src = url;
  });
}

preloadAllImages(IMAGES, () => {
  loadingText.style.display = 'none';
  menuArea.style.display = 'block';
  setMochikumaImage(IMAGES.NORMAL);
});

function setMochikumaImage(url) { mk.style.backgroundImage = `url('${url}')`; }

ruleBtn.addEventListener('click', () => ruleLayer.style.display = 'flex');
closeRuleBtn.addEventListener('click', () => ruleLayer.style.display = 'none');

const startDodge = (e) => { 
  if (e.cancelable) e.preventDefault();
  if(!state.active) return; 
  state.dodging = true; 
  mk.classList.add('dodging'); 
  setMochikumaImage(IMAGES.DODGE);
};
const endDodge = (e) => { 
  if (e.cancelable) e.preventDefault();
  state.dodging = false; 
  mk.classList.remove('dodging'); 
  if(state.active) setMochikumaImage(IMAGES.NORMAL);
};

dodgeBtn.addEventListener('touchstart', startDodge, {passive: false});
dodgeBtn.addEventListener('touchend', endDodge, {passive: false});
dodgeBtn.addEventListener('mousedown', startDodge);
window.addEventListener('mouseup', endDodge);

startBtn.addEventListener('click', () => { if(state.canStart) startSequence(); });

function startSequence() {
  bgm.volume = 0.2; 
  bgm.currentTime = 0;
  bgm.play().catch(e => console.log("å†ç”Ÿå¤±æ•—:", e));
  
  state.canStart = false;
  msgLayer.style.display = 'none';
  setMochikumaImage(IMAGES.NORMAL);
  countdownDisp.style.display = 'block';
  countdownDisp.innerText = 'Ready';
  setTimeout(() => {
    countdownDisp.innerText = 'Go!';
    setTimeout(() => {
      countdownDisp.style.display = 'none';
      initGame();
    }, 800);
  }, 1000);
}

function initGame() {
  if (spawnTimer) clearTimeout(spawnTimer);
  document.querySelectorAll('.obj').forEach(o => o.remove());
  
  state = { ...state, score: 0, life: 3, active: true, dodging: false, speed: 6, canStart: false };
  mk.classList.remove('dodging'); 
  setMochikumaImage(IMAGES.NORMAL);
  
  scoreDisp.innerText = `SCORE: 0`;
  updateLife();
  spawn();
}

function spawn() {
  if(!state.active) return;
  const obj = document.createElement('div');
  const isJob = Math.random() > 0.4;
  obj.className = `obj ${isJob ? 'job' : 'rest'}`;
  obj.innerText = isJob ? 'ä»•äº‹' : 'ä¼‘ã¿';
  document.getElementById('game-field').appendChild(obj);

  let posY = -100;
  let hasChecked = false;
  const currentSpeed = Math.min(state.speed + (state.score / 25), 18);

  const loop = setInterval(() => {
    if(!state.active) { clearInterval(loop); obj.remove(); return; }
    posY += currentSpeed;
    obj.style.transform = `translate3d(-50%, ${posY}px, 0)`;

    const objRect = obj.getBoundingClientRect();
    const mkRect = mk.getBoundingClientRect();

    if(!hasChecked && objRect.bottom > mkRect.top && objRect.top < mkRect.bottom) {
      if(!state.dodging) {
        hasChecked = true;
        if(isJob) { endGame('job'); clearInterval(loop); }
        else { state.score += 10; scoreDisp.innerText = `SCORE: ${state.score}`; obj.remove(); clearInterval(loop); }
      }
    }
    if(!hasChecked && objRect.top > mkRect.bottom) {
      hasChecked = true;
      if(!isJob) { 
        state.life--; 
        updateLife(); 
        if(state.life <= 0) { endGame('rest'); clearInterval(loop); } 
      }
    }
    if(posY > document.getElementById('game-field').clientHeight + 150) { obj.remove(); clearInterval(loop); }
  }, 16);
  spawnTimer = setTimeout(spawn, Math.max(1800 - (state.score * 12), 550));
}

function updateLife() {
  const currentLife = Math.max(0, state.life);
  lifeDisp.innerText = `LIFE: ${'â¤'.repeat(currentLife)}${'â™¡'.repeat(3 - currentLife)}`;
}

function endGame(reason) {
  state.active = false;
  bgm.pause();
  if (spawnTimer) clearTimeout(spawnTimer);
  document.querySelectorAll('.obj').forEach(o => o.remove());
  if(reason === 'job') {
    setMochikumaImage(IMAGES.HIT_JOB);
    msgText.innerHTML = `ä»•äº‹ã«å½“ãŸã£ã¦ã—ã¾ã£ãŸâ€¦<br>SCORE: ${state.score}`;
  } else {
    setMochikumaImage(IMAGES.HIT_REST);
    msgText.innerHTML = `ä¼‘ã¿ãŒè¶³ã‚Šãªã„â€¦<br>SCORE: ${state.score}`;
  }
  
  startBtn.innerText = 'å†æŒ‘æˆ¦';
  msgLayer.style.display = 'flex';
  setTimeout(() => { state.canStart = true; }, 800);
}
</script>
</body>
</html>
