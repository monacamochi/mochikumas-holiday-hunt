<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>もちくまの休日ハント</title>
  <style>
    /* 基本レイアウト */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: #f0f0f0; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; display: flex; justify-content: center; align-items: center; }
    #game-wrap { width: 100vw; max-width: 450px; height: 100vh; height: 100dvh; position: relative; background: #eef6ff; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    
    /* ステータスバー（レイアウト維持） */
    #status { height: 60px; display: flex; align-items: center; padding: 0 15px; font-weight: bold; color: #666; background: #f5faff; border-bottom: 1px solid #dee7ef; z-index: 50; }
    #score { font-size: 0.9rem; white-space: nowrap; }
    .spacer { flex-grow: 1; }
    .status-right { display: flex; align-items: center; gap: 12px; }
    #life { display: flex; align-items: center; gap: 4px; color: #ff6b6b; font-size: 0.9rem; white-space: nowrap; }
    .heart-icon { width: 22px; height: 22px; object-fit: contain; display: block; }
    #mute-btn { width: 30px; height: 30px; background-color: transparent; background-image: url('volume-ON.png'); background-size: contain; background-repeat: no-repeat; background-position: center; border: none; cursor: pointer; outline: none; }

    #game-field { flex: 1; position: relative; overflow: hidden; width: 100%; }
    #mochikuma { width: 120px; height: 132px; position: absolute; bottom: 40px; left: 50%; transform: translate3d(-50%, 0, 0); background-size: contain; background-repeat: no-repeat; background-position: center bottom; z-index: 5; }

    /* タイトルロゴのアニメーション定義 */
    @keyframes poyon {
      0% { transform: scale(0); opacity: 0; }
      70% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    #title-logo { 
      max-width: 280px; 
      height: auto; 
      margin-bottom: 12px; 
      display: block; 
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
      /* アニメーション適用 */
      animation: poyon 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      transform-origin: center;
    }

    #msg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; display: flex; justify-content: center; align-items: flex-start; padding-top: 90px; z-index: 20; pointer-events: none; }
    #msg-content { pointer-events: auto; text-align: center; padding: 35px 20px; background-image: url('kumo.png'); background-size: 100% 100%; background-repeat: no-repeat; width: 320px; height: 227px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    
    #rule-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center; z-index: 100; }
    #rule-content { text-align: center; padding: 25px; background: #fff; border-radius: 12px; width: 85%; }
    
    #start-btn, #rule-btn, #close-rule-btn, #share-btn { padding: 6px 16px; margin: 4px; font-size: 0.85rem; font-weight: bold; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    #ui-area { height: 140px; display: flex; align-items: center; justify-content: center; background: #f5faff; border-top: 1px solid #dee7ef; z-index: 10; padding-bottom: env(safe-area-inset-bottom); }
    #dodge-btn { width: 70%; height: 80px; font-size: 1.8rem; font-weight: bold; background: #0056b3; border: none; border-radius: 40px; color: #ffffff; box-shadow: 0 4px 0 #003d7a; }
  </style>
</head>
<body>
<div id="preloader" style="display:none;"></div>
<div id="game-wrap">
  <div id="status">
    <div id="score">SCORE: 0</div>
    <div class="spacer"></div>
    <div class="status-right">
      <div id="life">LIFE：<span id="heart-wrap"></span></div>
      <button id="mute-btn"></button>
    </div>
  </div>
  <div id="game-field">
    <div id="mochikuma"></div>
    <div id="countdown" style="display: none;"></div>
  </div>
  <div id="msg-layer">
    <div id="msg-content">
      <div id="loading-text">Now loading...</div>
      <div id="menu-area" style="display: none;">
        <img src="title.png" id="title-logo" alt="もちくまの休日ハント">
        <p id="msg-text" style="display: none;"></p>
        <div id="menu-btns">
          <button id="start-btn">開始</button>
          <button id="share-btn">結果をシェア</button>
          <button id="rule-btn">ルール</button>
        </div>
      </div>
    </div>
  </div>
  <div id="rule-layer" style="display: none;">
    <div id="rule-content">
      <h3>【ルール】</h3>
      <p>・落ちてくる「現実」をよける</p>
      <p>・「休日」は当たって勝ち取る</p>
      <button id="close-rule-btn">閉じる</button>
    </div>
  </div>
  <div id="ui-area">
    <button id="dodge-btn">よける</button>
  </div>
</div>

<script>
// ロジック部分は以前のコードをそのまま継承（音量トグル含む）
const mk = document.getElementById('mochikuma');
const dodgeBtn = document.getElementById('dodge-btn');
const msgLayer = document.getElementById('msg-layer');
const ruleLayer = document.getElementById('rule-layer');
const scoreDisp = document.getElementById('score');
const heartWrap = document.getElementById('heart-wrap');
const startBtn = document.getElementById('start-btn');
const ruleBtn = document.getElementById('rule-btn');
const shareBtn = document.getElementById('share-btn');
const closeRuleBtn = document.getElementById('close-rule-btn');
const loadingText = document.getElementById('loading-text');
const menuArea = document.getElementById('menu-area');
const muteBtn = document.getElementById('mute-btn');
const titleLogo = document.getElementById('title-logo');
const msgText = document.getElementById('msg-text');

const IMAGES = {
  NORMAL: 'default.png', DODGE: 'yoke.png', HIT_REST: 'yasumi.png',
  KYUZITU: 'kyuzitu.png', GET: 'default-get.png',
  HEART_A: 'heart-A.png', HEART_B: 'heart-B.png',
  VOL_ON: 'volume-ON.png', VOL_OFF: 'volume-OFF.png'
};

let state = { score: 0, life: 3, active: false, dodging: false, speed: 6, canStart: true, isMuted: false, mode: 'title' };

function updateLife() {
  heartWrap.innerHTML = '';
  for (let i = 0; i < 3; i++) {
    const img = document.createElement('img');
    img.className = 'heart-icon';
    img.src = i < state.life ? IMAGES.HEART_A : IMAGES.HEART_B;
    heartWrap.appendChild(img);
  }
}

muteBtn.addEventListener('click', () => {
  state.isMuted = !state.isMuted;
  muteBtn.style.backgroundImage = `url('${state.isMuted ? IMAGES.VOL_OFF : IMAGES.VOL_ON}')`;
});

// タイトルへ戻る際、ロゴのアニメーションを再発火させるための処理
function backToTitle() {
  state.mode = 'title';
  titleLogo.style.display = 'block';
  msgText.style.display = 'none';
  startBtn.innerText = '開始';
  ruleBtn.style.display = 'inline-block';
  shareBtn.style.display = 'none';
  
  // アニメーションをリセットして再実行
  titleLogo.style.animation = 'none';
  titleLogo.offsetHeight; 
  titleLogo.style.animation = null;
}

// 初期ロード完了後
setTimeout(() => {
  loadingText.style.display = 'none';
  menuArea.style.display = 'block';
  updateLife();
}, 1000);

startBtn.addEventListener('click', () => {
  if (state.mode === 'title') {
    state.active = true;
    state.mode = 'game';
    msgLayer.style.display = 'none';
  } else if (state.mode === 'result') {
    backToTitle();
  }
});

ruleBtn.addEventListener('click', () => ruleLayer.style.display = 'flex');
closeRuleBtn.addEventListener('click', () => ruleLayer.style.display = 'none');
</script>
</body>
</html>
