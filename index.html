<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta property="og:title" content="もちくまの休日ハント">
  <meta property="og:description" content="迫りくる現実をよけて、休日を勝ち取ろう！">
  <meta property="og:image" content="https://mochikumas-holiday-hunt.vercel.app/ogpimage.png">
  <meta property="og:url" content="https://mochikumas-holiday-hunt.vercel.app/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>もちくまの休日ハント</title>
  <style>
    /* 以前の安定したスタイルを維持 */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: #f0f0f0; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; display: flex; justify-content: center; align-items: center; }
    #game-wrap { width: 100vw; max-width: 450px; height: 100vh; height: 100dvh; position: relative; background: #eef6ff; display: flex; flex-direction: column; }
    
    #status { height: 60px; display: flex; align-items: center; padding: 0 15px; background: #f5faff; border-bottom: 1px solid #dee7ef; z-index: 50; }
    #score { font-size: 0.9rem; color: #497297; font-weight: bold; }
    .spacer { flex-grow: 1; }
    #life { display: flex; align-items: center; gap: 4px; color: #ff6b6b; font-size: 0.9rem; margin-right: 10px; }
    .heart-icon { width: 22px; height: 22px; object-fit: contain; }
    
    #game-field { flex: 1; position: relative; overflow: hidden; }

    /* もちくま：挙動がスムーズだった頃の設定 */
    #mochikuma { 
      width: 120px; height: 132px; position: absolute; bottom: 40px; left: 50%; 
      transform: translate3d(-50%, 0, 0); 
      background-size: contain; background-repeat: no-repeat; background-position: center bottom; 
      transition: transform 0.1s ease-out; z-index: 5; 
      will-change: transform;
    }
    #mochikuma.dodging { transform: translate3d(50%, 0, 0); }

    /* 点滅防止：画面外で読み込ませておく */
    #preload-area { position: absolute; top: -999px; left: -999px; opacity: 0.01; pointer-events: none; }

    #countdown { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: bold; color: #555; z-index: 15; }

    #msg-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: flex-start; padding-top: 90px; z-index: 20; }
    #msg-content { text-align: center; background-image: url('./kumo.png'); background-size: 100% 100%; width: 320px; height: 227px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    #title-logo { max-width: 280px; }
    
    #ui-area { height: 140px; display: flex; align-items: center; justify-content: center; background: #f5faff; border-top: 1px solid #dee7ef; z-index: 10; padding-bottom: env(safe-area-inset-bottom); }
    #dodge-btn { display: none; width: 70%; height: 80px; font-size: 1.8rem; font-weight: bold; background: #0056b3; border: none; border-radius: 40px; color: #fff; box-shadow: 0 4px 0 #003d7a; }
    
    #start-btn, #share-btn { padding: 8px 16px; margin: 4px; border-radius: 8px; border: 1px solid #ccc; font-weight: bold; color: #497297; cursor: pointer; }
    #start-btn { background: #E3F3FF; }
    #share-btn { background: #fff; display: none; }
  </style>
</head>
<body>

<div id="preload-area">
  <img src="./default.png">
  <img src="./yoke.png">
  <img src="./default-get.png">
  <img src="./gameover-shigoto.png">
  <img src="./gameover-kazi.png">
  <img src="./gameover-gakkou.png">
  <img src="./yasumi.png">
  <img src="./heart-A.png">
  <img src="./heart-B.png">
</div>

<div id="game-wrap">
  <div id="status">
    <div id="score">SCORE: 0</div>
    <div class="spacer"></div>
    <div id="life">LIFE：<span id="heart-wrap"></span></div>
  </div>

  <div id="game-field">
    <div id="mochikuma" style="background-image: url('./default.png');"></div>
    <div id="countdown" style="display:none;"></div>
  </div>

  <div id="msg-layer">
    <div id="msg-content">
      <img src="./title.png" id="title-logo">
      <p id="msg-text" style="display:none; font-weight:bold; color:#497297; margin:10px 0; line-height:1.4;"></p>
      <div id="btn-area">
        <button id="start-btn">開始</button>
        <button id="share-btn">結果をシェア</button>
      </div>
    </div>
  </div>

  <div id="ui-area">
    <button id="dodge-btn">よける</button>
  </div>
</div>

<script>
const mk = document.getElementById('mochikuma');
const state = { score: 0, life: 3, active: false, dodging: false, isSmiling: false };

function setImg(url) { mk.style.backgroundImage = `url('${url}')`; }

function spawn() {
  if (!state.active) return;
  const obj = document.createElement('div');
  obj.className = 'obj';
  obj.style.position = 'absolute';
  obj.style.left = '50%';
  obj.style.top = '0';
  obj.style.width = '80px';
  obj.style.height = '80px';
  obj.style.backgroundSize = 'contain';
  obj.style.backgroundRepeat = 'no-repeat';
  obj.style.backgroundPosition = 'center';
  obj.style.zIndex = '4';

  const isNeg = Math.random() > 0.5;
  const types = [
    {img:'./sigoto.png', go:'./gameover-shigoto.png', n:'仕事'},
    {img:'./kazi.png', go:'./gameover-kazi.png', n:'家事'},
    {img:'./gakkou.png', go:'./gameover-gakkou.png', n:'学校'}
  ];
  const t = isNeg ? types[Math.floor(Math.random()*3)] : {img:'./kyuzitu.png'};
  obj.style.backgroundImage = `url('${t.img}')`;
  document.getElementById('game-field').appendChild(obj);

  let posY = -100;
  const loop = setInterval(() => {
    if (!state.active) { clearInterval(loop); obj.remove(); return; }
    posY += (6 + state.score/50);
    obj.style.transform = `translate3d(-50%, ${posY}px, 0)`;

    const oR = obj.getBoundingClientRect();
    const mR = mk.getBoundingClientRect();

    if (oR.bottom > mR.top + 20 && oR.top < mR.bottom - 20 && oR.right > mR.left + 25 && oR.left < mR.right - 25) {
      if (!state.dodging) {
        if (isNeg) {
          state.active = false;
          setImg(t.go);
          showResult(`${t.n}には勝てなかった…`);
          clearInterval(loop);
        } else {
          state.score += 10;
          document.getElementById('score').innerText = `SCORE: ${state.score}`;
          state.isSmiling = true;
          setImg('./default-get.png');
          setTimeout(() => { 
            state.isSmiling = false; 
            if(state.active) setImg(state.dodging ? './yoke.png' : './default.png'); 
          }, 300);
          obj.remove(); clearInterval(loop);
        }
      }
    }
    if (posY > 800) {
      if (!isNeg) {
        state.life--; updateLife();
        if(state.life <= 0) {
          state.active = false;
          setImg('./yasumi.png');
          showResult('休日が足りない…');
          clearInterval(loop);
        }
      }
      obj.remove(); clearInterval(loop);
    }
  }, 16);
  setTimeout(spawn, Math.max(1800 - state.score*10, 600));
}

function updateLife() {
  const wrap = document.getElementById('heart-wrap');
  wrap.innerHTML = '';
  for(let i=0; i<3; i++) {
    const img = document.createElement('img');
    img.className = 'heart-icon';
    img.src = i < state.life ? './heart-A.png' : './heart-B.png';
    wrap.appendChild(img);
  }
}

function showResult(txt) {
  document.getElementById('title-logo').style.display = 'none';
  document.getElementById('msg-text').style.display = 'block';
  document.getElementById('msg-text').innerHTML = `${txt}<br>SCORE: ${state.score}`;
  document.getElementById('start-btn').innerText = 'タイトルに戻る';
  document.getElementById('share-btn').style.display = 'inline-block';
  document.getElementById('msg-layer').style.display = 'flex';
}

function startSequence() {
  document.getElementById('msg-layer').style.display = 'none';
  document.getElementById('dodge-btn').style.display = 'block';
  const cd = document.getElementById('countdown');
  cd.style.display = 'block'; cd.innerText = 'Ready';
  setTimeout(() => {
    cd.innerText = 'Go!';
    setTimeout(() => { cd.style.display = 'none'; state.active = true; spawn(); }, 800);
  }, 1000);
}

document.getElementById('start-btn').addEventListener('click', () => {
  if (document.getElementById('start-btn').innerText === '開始') {
    startSequence();
  } else {
    location.reload();
  }
});

document.getElementById('share-btn').addEventListener('click', () => {
  const text = `「もちくまの休日ハント」で遊んだよ！\nスコアは【${state.score}】でした！\n\n#もちくまの休日ハント`;
  const url = `https://mochikumas-holiday-hunt.vercel.app/`;
  window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
});

const startMove = (e) => {
  if (e.cancelable) e.preventDefault();
  if (!state.active) return;
  state.dodging = true; mk.classList.add('dodging');
  if (!state.isSmiling) setImg('./yoke.png');
};
const endMove = () => {
  state.dodging = false; mk.classList.remove('dodging');
  if (state.active && !state.isSmiling) setImg('./default.png');
};

document.getElementById('dodge-btn').addEventListener('touchstart', startMove);
document.getElementById('dodge-btn').addEventListener('touchend', endMove);

updateLife();
</script>
</body>
</html>
