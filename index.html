<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>„ÇÇ„Å°„Åè„Åæ„ÅÆ‰ºëÊó•„Éè„É≥„Éà</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: #f0f0f0; overflow: hidden; font-family: sans-serif; user-select: none; touch-action: none; display: flex; justify-content: center; align-items: center; }
    
    #game-wrap { width: 100vw; max-width: 450px; height: 100vh; height: 100dvh; position: relative; background: #eef6ff; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    #status { height: 60px; display: flex; justify-content: space-around; align-items: center; font-weight: bold; color: #666; background: #f5faff; border-bottom: 1px solid #dee7ef; z-index: 10; }
    #life { color: #ff6b6b; }
    #mute-btn { position: absolute; top: 15px; right: 15px; width: 30px; height: 30px; background: none; border: none; font-size: 1.5rem; cursor: pointer; z-index: 30; outline: none; }
    #game-field { flex: 1; position: relative; overflow: hidden; width: 100%; }
    
    #mochikuma {
      width: 120px; 
      height: 132px; 
      position: absolute; 
      bottom: 40px; 
      left: 50%;
      transform: translate3d(-50%, 0, 0); 
      background-size: contain; 
      background-repeat: no-repeat;
      background-position: center bottom; 
      transition: transform 0.1s ease-out; 
      z-index: 5; 
      will-change: transform;
    }
    #mochikuma.dodging { transform: translate3d(50%, 0, 0); }
    
    #countdown { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: bold; color: #555; z-index: 15; }
    
    .obj { 
      position: absolute; 
      left: 50%; 
      top: 0; 
      width: 80px; 
      height: 80px; 
      background-size: contain; 
      background-repeat: no-repeat; 
      background-position: center;
      z-index: 4; 
      transform: translate3d(-50%, -100px, 0); 
      will-change: transform; 
    }
    
    #ui-area { height: 140px; display: flex; align-items: center; justify-content: center; background: #f5faff; border-top: 1px solid #dee7ef; z-index: 10; padding-bottom: env(safe-area-inset-bottom); }
    #dodge-btn { width: 70%; height: 80px; font-size: 1.8rem; font-weight: bold; background: #0056b3; border: none; border-radius: 40px; color: #ffffff; outline: none; box-shadow: 0 4px 0 #003d7a; }
    #dodge-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #003d7a; }

    #msg-layer, #rule-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: transparent; display: flex; justify-content: center; align-items: flex-start; padding-top: 60px; z-index: 20; }
    
    #msg-content { 
      text-align: center; padding: 40px 30px; background-image: url('kumo.png'); background-size: 100% 100%; background-repeat: no-repeat; background-position: center;
      background-color: transparent; border: none; width: 320px; height: 227px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: none;
    }
    #rule-content { text-align: center; padding: 25px; background: #fff; border: 1px solid #eee; border-radius: 12px; width: 85%; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
    #msg-text { font-size: 1.1rem; font-weight: bold; margin-bottom: 12px; color: #444; line-height: 1.4; }
    #start-btn, #rule-btn, #close-rule-btn { padding: 10px 20px; margin: 5px; font-size: 0.9rem; font-weight: bold; border-radius: 10px; border: 1px solid #ccc; background: #fff; }
    #start-btn { background: #eee; }
    #rule-content p { font-size: 0.95rem; margin-bottom: 10px; text-align: left; line-height: 1.5; color: #444; }
    #loading-text { font-weight: bold; color: #aaa; padding: 30px; letter-spacing: 0.05em; }
    #preloader { position: absolute; width: 0; height: 0; overflow: hidden; opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
<div id="preloader"></div>
<audio id="bgm" src="bgm.mp3" loop></audio>

<div id="game-wrap">
  <button id="mute-btn">üîä</button>
  <div id="status">
    <div id="score">SCORE: 0</div>
    <div id="life">LIFE: ‚ù§‚ù§‚ù§</div>
  </div>
  <div id="game-field">
    <div id="mochikuma"></div>
    <div id="countdown" style="display: none;"></div>
  </div>
  <div id="msg-layer">
    <div id="msg-content">
      <div id="loading-text">Now loading...</div>
      <div id="menu-area" style="display: none;">
        <p id="msg-text">„ÇÇ„Å°„Åè„Åæ„ÅÆ‰ºëÊó•„Éè„É≥„Éà</p>
        <div id="menu-btns">
          <button id="start-btn">ÈñãÂßã</button>
          <button id="rule-btn">„É´„Éº„É´</button>
        </div>
      </div>
    </div>
  </div>
  <div id="rule-layer" style="display: none;">
    <div id="rule-content">
      <h3>„Äê„É´„Éº„É´„Äë</h3>
      <p>„ÉªËêΩ„Å°„Å¶„Åè„Çã„ÄåÁèæÂÆü„Äç„Çí„Çà„Åë„Çã</p>
      <p>„Éª„Äå‰ºëÊó•„Äç„ÅØÂΩì„Åü„Å£„Å¶Âãù„Å°Âèñ„Çã</p>
      <p>„Éª„Äå„Çà„Åë„Çã„Äç„Éú„Çø„É≥Èï∑Êäº„Åó„ÅßÂè≥ÁßªÂãï</p>
      <p>„Éª„Äå‰ºëÊó•„Äç„Çí3ÂõûÈÄÉ„Åô„Å®ÁµÇ‰∫Ü</p>
      <button id="close-rule-btn">Èñâ„Åò„Çã</button>
    </div>
  </div>
  <div id="ui-area">
    <button id="dodge-btn">„Çà„Åë„Çã</button>
  </div>
</div>

<script>
const mk = document.getElementById('mochikuma');
const dodgeBtn = document.getElementById('dodge-btn');
const msgLayer = document.getElementById('msg-layer');
const ruleLayer = document.getElementById('rule-layer');
const countdownDisp = document.getElementById('countdown');
const msgText = document.getElementById('msg-text');
const scoreDisp = document.getElementById('score');
const lifeDisp = document.getElementById('life');
const startBtn = document.getElementById('start-btn');
const ruleBtn = document.getElementById('rule-btn');
const closeRuleBtn = document.getElementById('close-rule-btn');
const loadingText = document.getElementById('loading-text');
const menuArea = document.getElementById('menu-area');
const preloader = document.getElementById('preloader');
const bgm = document.getElementById('bgm');
const muteBtn = document.getElementById('mute-btn');

const IMAGES = {
  NORMAL: 'default.png',
  DODGE:  'yoke.png',
  HIT_REST: 'yasumi.png',
  KUMO: 'kumo.png',
  SIGOTO: 'sigoto.png',
  KAZI: 'kazi.png',
  GAKKOU: 'gakkou.png',
  KYUZITU: 'kyuzitu.png',
  // ÂΩì„Åü„Å£„ÅüÊôÇ„ÅÆÂêÑ„Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÁîªÂÉè
  GO_SIGOTO: 'gameover-shigoto.png',
  GO_KAZI: 'gameover-kazi.png',
  GO_GAKKOU: 'gameover-gakkou.png'
};

const NEGATIVE_TYPES = [
  { img: IMAGES.SIGOTO, goImg: IMAGES.GO_
